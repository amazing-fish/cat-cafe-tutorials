<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>猫猫AI系统 - 圆桌讨论版（真实API版）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            claw: {
              dark: '#0f172a', 
              sidebar: '#1e293b', 
              primary: '#3b82f6', 
              secondary: '#64748b', 
              success: '#10b981', 
              danger: '#ef4444', 
              warning: '#f59e0b', 
              chat: { user: '#2563eb', ai: '#334155' },
              speed: { fast: '#10b981', balance: '#f59e0b', pro: '#ef4444' },
              roundtable: '#8b5cf6'
            }
          },
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] }
        }
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto { content-visibility: auto; }
      .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
      .scrollbar-hide::-webkit-scrollbar { display: none; }
      .chat-input-focus { @apply outline-none ring-2 ring-claw-primary/50; }
      /* 开关样式 */
      .toggle-switch:checked { @apply bg-claw-success; }
      .toggle-switch:checked + .toggle-slider { @apply translate-x-4 bg-white shadow-md; }
      .toggle-slider { @apply absolute top-0 left-0 right-0 bottom-0 bg-claw-secondary/40 border border-claw-secondary/60 rounded-full transition-all duration-300; }
      .toggle-dot { @apply absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full transition-transform duration-300 z-20 shadow-sm; }
      .toggle-switch:checked + .toggle-slider + .toggle-dot { @apply translate-x-4; }
      .toggle-container { @apply relative w-12 h-6 flex items-center px-0.5; }
      .toggle-status { @apply absolute text-xs font-medium pointer-events-none transition-opacity duration-200; }
      .toggle-status-on { @apply left-1.5 text-claw-success opacity-0; }
      .toggle-switch:checked ~ .toggle-status-on { @apply opacity-100; }
      .toggle-status-off { @apply right-1.5 text-claw-secondary opacity-100; }
      .toggle-switch:checked ~ .toggle-status-off { @apply opacity-0; }
      /* 通用样式 */
      .tab-active { @apply border-b-2 border-claw-primary text-white; }
      .role-collapse-active { @apply rotate-90; }
      .avatar-select-item { @apply w-10 h-10 rounded-full flex items-center justify-center cursor-pointer border-2 border-transparent hover:border-claw-primary transition-all; }
      .avatar-select-item.active { @apply border-claw-primary bg-claw-primary/20; }
      .role-card-enabled { @apply border-claw-success/60 bg-claw-success/5 ring-1 ring-claw-success/20; }
      .role-actions-container { @apply flex items-center gap-2 shrink-0; }
      /* 圆桌讨论样式 */
      .round-table-header { @apply border-l-4 border-claw-roundtable pl-3 mb-1 flex items-center gap-2; }
      .round-table-round { @apply text-xs text-claw-roundtable/80 font-medium; }
    }
  </style>
</head>
<body class="bg-claw-dark text-white font-sans h-screen flex overflow-hidden">
  <!-- 侧边栏 -->
  <aside class="w-80 bg-claw-sidebar h-full flex flex-col border-r border-claw-secondary/20 shrink-0">
    <div class="p-4 border-b border-claw-secondary/20 flex items-center gap-3">
      <i class="fa-solid fa-cat text-2xl text-claw-primary"></i>
      <h1 class="text-xl font-bold">猫猫AI系统</h1>
    </div>
    <div class="flex border-b border-claw-secondary/20" id="tab-nav">
      <button id="role-tab" class="tab-active flex-1 py-3 text-sm font-medium text-claw-secondary hover:text-white transition-colors">
        <i class="fa-solid fa-users mr-1"></i> 角色管理
      </button>
      <button id="setting-tab" class="flex-1 py-3 text-sm font-medium text-claw-secondary hover:text-white transition-colors">
        <i class="fa-solid fa-sliders mr-1"></i> 全局设置
      </button>
    </div>
    <!-- 角色管理面板 -->
    <div id="role-panel" class="flex-1 flex flex-col overflow-hidden">
      <div class="p-3 border-b border-claw-secondary/20 flex items-center justify-between">
        <span class="text-sm text-claw-secondary" id="role-count">已启用 0/0 个角色</span>
        <button id="add-role-btn" class="text-xs bg-claw-primary/80 hover:bg-claw-primary px-2 py-1 rounded transition-colors">
          <i class="fa-solid fa-plus mr-1"></i> 新增角色
        </button>
      </div>
      <div id="role-list" class="flex-1 p-3 overflow-y-auto scrollbar-hide space-y-3">
        <div class="text-center py-10 text-claw-secondary text-sm">
          <i class="fa-solid fa-inbox text-2xl mb-2 block"></i>
          暂无角色，点击右上角新增角色开始配置<br/>
          <span class="text-claw-warning text-xs mt-2 block">真实模式：需填写有效API密钥和模型信息</span>
        </div>
      </div>
      <div class="p-3 border-t border-claw-secondary/20 text-xs text-claw-secondary">
        <p>猫猫AI系统 圆桌讨论版 v2.3 真实API版</p>
        <p>支持 OpenAI / Claude / Ollama | 流式回复 | 多角色讨论</p>
      </div>
    </div>
    <!-- 设置面板 -->
    <div id="setting-panel" class="flex-1 p-4 overflow-y-auto scrollbar-hide hidden">
      <div class="space-y-6">
        <div>
          <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
            <i class="fa-solid fa-comments text-claw-primary"></i> 对话设置
          </h2>
          <div class="space-y-4">
            <div>
              <label class="block text-sm text-claw-secondary mb-2">全局对话温度 (0-2)</label>
              <input type="number" id="global-temperature" min="0" max="2" step="0.1" value="0.7" class="w-full bg-claw-dark border border-claw-secondary/30 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-claw-primary">
              <p class="text-xs text-claw-secondary mt-1">数值越低，回复越稳定；越高越有创意</p>
            </div>
            <div>
              <label class="block text-sm text-claw-secondary mb-2">单条回复最大Token数</label>
              <input type="number" id="global-max-tokens" min="1" max="128000" step="1" value="1000" class="w-full bg-claw-dark border border-claw-secondary/30 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-claw-primary">
              <p class="text-xs text-claw-secondary mt-1">1Token≈0.75个中文字</p>
            </div>
            <div class="flex items-center justify-between">
              <label class="block text-sm text-claw-secondary">新对话清空历史</label>
              <div class="toggle-container">
                <input type="checkbox" id="auto-clear-history" class="toggle-switch absolute w-full h-full opacity-0 z-10 cursor-pointer">
                <span class="toggle-slider"></span>
                <span class="toggle-dot"></span>
                <span class="toggle-status toggle-status-on">开</span>
                <span class="toggle-status toggle-status-off">关</span>
              </div>
            </div>
            <div class="flex items-center justify-between">
              <label class="block text-sm text-claw-secondary">智能调节回复字数</label>
              <div class="toggle-container">
                <input type="checkbox" id="auto-adjust-tokens" class="toggle-switch absolute w-full h-full opacity-0 z-10 cursor-pointer" checked>
                <span class="toggle-slider"></span>
                <span class="toggle-dot"></span>
                <span class="toggle-status toggle-status-on">开</span>
                <span class="toggle-status toggle-status-off">关</span>
              </div>
            </div>
            <div class="flex items-center justify-between">
              <label class="block text-sm text-claw-secondary">防重复输出优化</label>
              <div class="toggle-container">
                <input type="checkbox" id="anti-repeat-enable" class="toggle-switch absolute w-full h-full opacity-0 z-10 cursor-pointer" checked>
                <span class="toggle-slider"></span>
                <span class="toggle-dot"></span>
                <span class="toggle-status toggle-status-on">开</span>
                <span class="toggle-status toggle-status-off">关</span>
              </div>
            </div>
          </div>
        </div>
        <div class="border-t border-claw-secondary/20 pt-6">
          <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
            <i class="fa-solid fa-globe text-claw-primary"></i> 全局代理配置
          </h2>
          <div class="mb-4 flex items-center justify-between">
            <label class="block text-sm text-claw-secondary">启用全局NO_PROXY</label>
            <div class="toggle-container">
              <input type="checkbox" id="global-proxy-enable" class="toggle-switch absolute w-full h-full opacity-0 z-10 cursor-pointer">
              <span class="toggle-slider"></span>
              <span class="toggle-dot"></span>
              <span class="toggle-status toggle-status-on">开</span>
              <span class="toggle-status toggle-status-off">关</span>
            </div>
          </div>
          <div class="mb-3">
            <label class="block text-sm text-claw-secondary mb-2">NO_PROXY 域名（逗号分隔）</label>
            <input type="text" id="global-no-proxy-domains" class="w-full bg-claw-dark border border-claw-secondary/30 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-claw-primary" placeholder="如：api.openai.com,api.anthropic.com">
          </div>
        </div>
        <div class="border-t border-claw-secondary/20 pt-6">
          <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
            <i class="fa-solid fa-database text-claw-primary"></i> 数据管理
          </h2>
          <div class="grid grid-cols-2 gap-3">
            <button id="clear-history-btn" class="bg-claw-warning/20 hover:bg-claw-warning/30 text-claw-warning rounded-md px-3 py-2 text-sm font-medium transition-colors">
              <i class="fa-solid fa-trash mr-1"></i> 清空对话历史
            </button>
            <button id="reset-all-btn" class="bg-claw-danger/20 hover:bg-claw-danger/30 text-claw-danger rounded-md px-3 py-2 text-sm font-medium transition-colors">
              <i class="fa-solid fa-refresh mr-1"></i> 重置所有配置
            </button>
          </div>
          <button id="export-config-btn" class="w-full mt-3 bg-claw-dark border border-claw-secondary/30 hover:border-claw-primary rounded-md px-3 py-2 text-sm font-medium transition-colors">
            <i class="fa-solid fa-download mr-1"></i> 导出配置文件
          </button>
        </div>
      </div>
    </div>
  </aside>

  <!-- 主内容区 -->
  <main class="flex-1 h-full flex flex-col min-w-0">
    <div id="chat-container" class="flex-1 p-6 overflow-y-auto scrollbar-hide bg-claw-dark">
      <div class="flex flex-col items-start gap-2 mb-8 max-w-4xl mx-auto w-full">
        <div class="flex items-center gap-2 mb-1">
          <i class="fa-solid fa-cat text-claw-primary"></i>
          <span class="font-medium">猫猫AI系统</span>
          <span class="text-xs text-claw-secondary">圆桌讨论版 v2.3 真实API版</span>
        </div>
        <div class="bg-claw-chat-ai rounded-lg rounded-tl-none px-4 py-3 w-full">
          配置流程：<b>新增角色 → 填写API信息 → 启用角色</b><br>
          圆桌讨论：输入主题+轮数，启动后AI角色多轮讨论反驳，最终生成结论！<br>
          <span class="text-claw-warning text-xs">真实模式：需填写有效API密钥，产生真实API调用费用</span>
        </div>
      </div>
    </div>

    <!-- 圆桌讨论输入区 -->
    <div class="p-3 border-t border-claw-secondary/20 bg-claw-sidebar/30">
      <div class="max-w-4xl mx-auto w-full space-y-2">
        <div class="flex items-center gap-2">
          <i class="fa-solid fa-table-cells-large text-claw-roundtable"></i>
          <span class="text-sm font-medium">圆桌讨论</span>
          <input type="number" id="round-table-rounds" min="1" max="10" value="3" class="w-16 bg-claw-dark border border-claw-secondary/30 rounded-md px-2 py-1 text-xs text-center" placeholder="轮数">
          <span class="text-xs text-claw-secondary">轮</span>
        </div>
        <div class="flex gap-2">
          <input type="text" id="round-table-topic" placeholder="输入讨论主题（如：如何优化AI回复质量？）" class="flex-1 bg-claw-dark border border-claw-secondary/30 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-claw-roundtable">
          <button id="start-round-table-btn" class="bg-claw-roundtable hover:bg-claw-roundtable/90 rounded-md px-4 py-2 text-sm font-medium transition-colors shrink-0" disabled>
            <i class="fa-solid fa-play mr-1"></i> 启动讨论
          </button>
        </div>
      </div>
    </div>

    <!-- 普通聊天输入区 -->
    <div class="p-4 border-t border-claw-secondary/20 bg-claw-sidebar/50">
      <form id="chat-form" class="flex gap-3 items-end max-w-4xl mx-auto w-full">
        <textarea 
          id="chat-input" 
          placeholder="输入消息，按Enter发送（Shift+Enter换行）..."
          class="flex-1 bg-claw-dark border border-claw-secondary/30 rounded-md px-4 py-3 text-sm resize-none min-h-[60px] max-h-[200px] overflow-y-auto chat-input-focus scrollbar-hide"
        ></textarea>
        <button 
          type="submit"
          id="send-btn"
          class="bg-claw-primary hover:bg-claw-primary/90 rounded-md p-3 transition-colors flex items-center justify-center h-[60px] w-[60px] shrink-0"
          title="发送消息"
          disabled
        >
          <i class="fa-solid fa-paper-plane"></i>
        </button>
      </form>
      <p id="status-text" class="text-xs text-claw-secondary mt-2 pl-1 hidden max-w-4xl mx-auto w-full">
        <i class="fa-solid fa-spinner fa-spin"></i> <span id="current-role-text">准备开始思考...</span>
      </p>
    </div>
  </main>

  <script>
    // 全局常量 - 各服务商默认模型列表
    const PROVIDER_MODELS = {
      openai: [
        { id: 'gpt-3.5-turbo', name: 'GPT-3.5 Turbo' },
        { id: 'gpt-4-turbo', name: 'GPT-4 Turbo' },
        { id: 'gpt-4o', name: 'GPT-4o' },
        { id: 'gpt-4o-mini', name: 'GPT-4o Mini' }
      ],
      anthropic: [
        { id: 'claude-3-haiku-20240307', name: 'Claude 3 Haiku' },
        { id: 'claude-3-5-sonnet-20240620', name: 'Claude 3.5 Sonnet' },
        { id: 'claude-3-opus-20240229', name: 'Claude 3 Opus' }
      ],
      ollama: [
        { id: 'llama3:8b', name: 'Llama3 8B' },
        { id: 'llama3:70b', name: 'Llama3 70B' },
        { id: 'qwen2:7b', name: '通义千问2 7B' },
        { id: 'gemma2:9b', name: 'Gemma2 9B' }
      ]
    };
    
    const INVALID_MODEL_KEYWORDS = ['embedding', 'ada', 'babbage', 'curie', 'edit', 'whisper'];
    const MODEL_SPEED_RULES = [
      { speed: 'fast', keywords: ['3.5-turbo', 'haiku', '8b', '7b', 'tiny'] },
      { speed: 'pro', keywords: ['4o', 'opus', '70b', '8x7b', 'large'] },
      { speed: 'balance', keywords: ['4-turbo', 'sonnet', 'medium'] }
    ];
    const AVATAR_OPTIONS = [
      { icon: 'fa-cat', label: '猫咪' }, { icon: 'fa-heart', label: '爱心' },
      { icon: 'fa-paw', label: '爪子' }, { icon: 'fa-robot', label: '机器人' },
      { icon: 'fa-user-astronaut', label: '宇航员' }, { icon: 'fa-star', label: '星星' }
    ];

    // 全局状态
    let roleList = []; 
    let activeRoleCount = 0; 
    let isGenerating = false; 
    let chatHistory = JSON.parse(localStorage.getItem('openclaw-multi-chat-history')) || [];
    let roleIdCounter = 0; 
    let isRoundTableRunning = false;
    let roundTableHistory = [];

    // DOM元素
    const roleTab = document.getElementById('role-tab');
    const settingTab = document.getElementById('setting-tab');
    const rolePanel = document.getElementById('role-panel');
    const settingPanel = document.getElementById('setting-panel');
    const roleListEl = document.getElementById('role-list');
    const roleCountEl = document.getElementById('role-count');
    const addRoleBtn = document.getElementById('add-role-btn');
    const globalTemperature = document.getElementById('global-temperature');
    const globalMaxTokens = document.getElementById('global-max-tokens');
    const autoClearHistory = document.getElementById('auto-clear-history');
    const autoAdjustTokens = document.getElementById('auto-adjust-tokens');
    const antiRepeatEnable = document.getElementById('anti-repeat-enable');
    const globalProxyEnable = document.getElementById('global-proxy-enable');
    const globalNoProxyDomains = document.getElementById('global-no-proxy-domains');
    const clearHistoryBtn = document.getElementById('clear-history-btn');
    const resetAllBtn = document.getElementById('reset-all-btn');
    const exportConfigBtn = document.getElementById('export-config-btn');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const chatContainer = document.getElementById('chat-container');
    const statusText = document.getElementById('status-text');
    const currentRoleText = document.getElementById('current-role-text');
    const sendBtn = document.getElementById('send-btn');
    const roundTableTopic = document.getElementById('round-table-topic');
    const roundTableRounds = document.getElementById('round-table-rounds');
    const startRoundTableBtn = document.getElementById('start-round-table-btn');

    // 初始化
    window.onload = function() {
      init();
    };

    function init() {
      loadAllConfig();
      renderRoleList();
      renderChatHistory();
      bindEvents();
      setTimeout(() => {
        updateSendBtnStatus();
        updateRoundTableBtnStatus();
      }, 100);
      scrollToBottom();
    }

    // 事件绑定
    function bindEvents() {
      // 标签切换
      roleTab.addEventListener('click', () => switchTab('role'));
      settingTab.addEventListener('click', () => switchTab('setting'));
      
      // 角色管理
      addRoleBtn.addEventListener('click', addNewRole);
      clearHistoryBtn.addEventListener('click', clearChatHistory);
      resetAllBtn.addEventListener('click', resetAllConfig);
      exportConfigBtn.addEventListener('click', exportAllConfig);
      
      // 全局设置保存
      [globalTemperature, globalMaxTokens, autoClearHistory, autoAdjustTokens, antiRepeatEnable,
        globalProxyEnable, globalNoProxyDomains].forEach(el => {
          if (el) el.addEventListener('change', saveGlobalConfig);
        });
      
      // 普通聊天
      chatForm.addEventListener('submit', handleChatSubmit);
      chatInput.addEventListener('keydown', handleInputKeydown);
      chatInput.addEventListener('input', updateSendBtnStatus);
      
      // 圆桌讨论
      roundTableTopic.addEventListener('input', updateRoundTableBtnStatus);
      roundTableRounds.addEventListener('change', updateRoundTableBtnStatus);
      startRoundTableBtn.addEventListener('click', startRoundTableDiscussion);
    }

    // 标签切换
    function switchTab(tabName) {
      if (tabName === 'role') {
        roleTab.classList.add('tab-active');
        settingTab.classList.remove('tab-active');
        rolePanel.classList.remove('hidden');
        settingPanel.classList.add('hidden');
      } else {
        settingTab.classList.add('tab-active');
        roleTab.classList.remove('tab-active');
        settingPanel.classList.remove('hidden');
        rolePanel.classList.add('hidden');
      }
    }

    // 角色管理核心
    function addNewRole() {
      roleIdCounter++;
      roleList.push({
        id: roleIdCounter,
        name: `猫猫AI助手${roleIdCounter}`, 
        avatar: 'fa-cat',
        avatarUrl: '',
        enable: false,
        provider: 'openai',
        baseUrl: 'https://api.openai.com/v1',
        apiKey: '',
        model: 'gpt-3.5-turbo',
        modelName: 'GPT-3.5 Turbo',
        proxyEnabled: false,
        noProxyDomains: '',
        systemPrompt: '你是一个友好的AI助手，回复简洁明了，逻辑清晰。'
      });
      saveRoleConfig();
      renderRoleList();
      // 新增后自动展开
      setTimeout(() => {
        const newRoleEl = document.getElementById(`role-${roleIdCounter}`);
        if (newRoleEl) {
          newRoleEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
          setTimeout(() => {
            const collapseHeader = newRoleEl.querySelector('.role-collapse-header');
            if (collapseHeader) collapseHeader.click();
          }, 100);
        }
      }, 100);
      updateSendBtnStatus();
      updateRoundTableBtnStatus();
    }

    function deleteRole(roleId) {
      if (!confirm(`确定删除「${roleList.find(r => r.id === roleId)?.name}」？`)) return;
      roleList = roleList.filter(role => role.id !== roleId);
      saveRoleConfig();
      renderRoleList();
      updateRoundTableBtnStatus();
      updateSendBtnStatus();
    }

    // 角色启用校验（真实模式：检查API配置）
    function toggleRoleEnable(roleId) {
      const role = roleList.find(r => r.id === roleId);
      if (!role) return;

      // 真实模式：启用前校验核心配置
      if (!role.enable) {
        if (!role.apiKey || role.apiKey.trim() === '') {
          alert(`启用失败：角色「${role.name}」未填写API密钥！`);
          return;
        }
        if (!role.model || role.model.trim() === '') {
          alert(`启用失败：角色「${role.name}」未选择模型！`);
          return;
        }
        if (!role.baseUrl || role.baseUrl.trim() === '') {
          alert(`启用失败：角色「${role.name}」未填写API基础URL！`);
          return;
        }
      }

      role.enable = !role.enable;
      saveRoleConfig();
      renderRoleList();
      updateSendBtnStatus();
      updateRoundTableBtnStatus();
    }

    function updateRoleConfig(roleId, field, value) {
      const role = roleList.find(r => r.id === roleId);
      if (!role) return;
      role[field] = value;
      
      // 切换服务商时更新默认配置
      if (field === 'provider') {
        role.baseUrl = role.provider === 'openai' ? 'https://api.openai.com/v1' : 
                      role.provider === 'anthropic' ? 'https://api.anthropic.com/v1' : 
                      'http://localhost:11434/v1';
        // 切换服务商后重置默认模型
        const defaultModel = PROVIDER_MODELS[role.provider][0];
        role.model = defaultModel.id;
        role.modelName = defaultModel.name;
      }
      saveRoleConfig();
      
      // 如果是模型字段，更新模型名称
      if (field === 'model') {
        const modelInfo = Object.values(PROVIDER_MODELS).flat().find(m => m.id === value);
        role.modelName = modelInfo ? modelInfo.name : value;
      }
    }

    // 渲染角色列表
    function renderRoleList() {
      activeRoleCount = roleList.filter(role => role.enable).length;
      roleCountEl.textContent = `已启用 ${activeRoleCount}/${roleList.length} 个角色`;

      if (roleList.length === 0) {
        roleListEl.innerHTML = `<div class="text-center py-10 text-claw-secondary text-sm"><i class="fa-solid fa-inbox text-2xl mb-2 block"></i> 暂无角色，点击右上角新增<br/><span class="text-claw-warning text-xs mt-2 block">真实模式：需填写API密钥和模型信息</span></div>`;
        return;
      }

      roleListEl.innerHTML = '';
      roleList.forEach(role => {
        const roleCard = document.createElement('div');
        roleCard.id = `role-${role.id}`;
        roleCard.className = `border border-claw-secondary/20 rounded-lg overflow-hidden transition-all duration-300 ${role.enable ? 'role-card-enabled' : ''}`;
        roleCard.innerHTML = `
          <div class="flex items-center justify-between p-3 bg-claw-dark/50 cursor-pointer role-collapse-header" data-role-id="${role.id}">
            <div class="flex items-center gap-2 flex-1 min-w-0 mr-2">
              <i class="fa-solid fa-chevron-right text-xs text-claw-secondary transition-transform role-collapse-icon"></i>
              <div class="w-8 h-8 rounded-full bg-claw-primary/20 flex items-center justify-center shrink-0">
                ${role.avatarUrl ? 
                  `<img src="${role.avatarUrl}" class="w-full h-full rounded-full object-cover" alt="${role.name}">` : 
                  `<i class="fa-solid ${role.avatar} text-claw-primary"></i>`
                }
              </div>
              <div class="flex-1 min-w-0">
                <p class="font-medium text-sm truncate">${role.name}</p>
                <p class="text-xs text-claw-secondary truncate">${role.modelName || role.model} | ${role.enable ? '<span class="text-claw-success">已启用</span>' : '<span class="text-claw-secondary">已禁用</span>'}</p>
              </div>
            </div>
            <div class="role-actions-container">
              <div class="toggle-container">
                <input type="checkbox" class="toggle-switch role-enable-switch absolute w-full h-full opacity-0 z-10 cursor-pointer" data-role-id="${role.id}" ${role.enable ? 'checked' : ''}>
                <span class="toggle-slider"></span>
                <span class="toggle-dot"></span>
                <span class="toggle-status toggle-status-on">开</span>
                <span class="toggle-status toggle-status-off">关</span>
              </div>
              <button class="role-delete-btn text-claw-secondary hover:text-claw-danger p-2 rounded-full transition-colors" data-role-id="${role.id}" title="删除角色">
                <i class="fa-solid fa-trash"></i>
              </button>
            </div>
          </div>
          <div class="role-collapse-content p-3 border-t border-claw-secondary/20 space-y-3 hidden">
            <div>
              <label class="block text-sm text-claw-secondary mb-2">角色头像</label>
              <div class="mb-2 flex flex-wrap gap-2">
                ${AVATAR_OPTIONS.map(item => `
                  <div class="avatar-select-item ${role.avatar === item.icon && !role.avatarUrl ? 'active' : ''}" data-role-id="${role.id}" data-avatar="${item.icon}">
                    <i class="fa-solid ${item.icon} text-lg"></i>
                  </div>
                `).join('')}
              </div>
              <input type="text" class="avatar-url-input w-full bg-claw-dark border border-claw-secondary/30 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-claw-primary" data-role-id="${role.id}" value="${role.avatarUrl}" placeholder="自定义头像URL">
            </div>
            <div>
              <label class="block text-sm text-claw-secondary mb-2">角色名称</label>
              <input type="text" class="role-name-input w-full bg-claw-dark border border-claw-secondary/30 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-claw-primary" data-role-id="${role.id}" value="${role.name}" placeholder="角色名称">
            </div>
            <div>
              <label class="block text-sm text-claw-secondary mb-2">模型服务商</label>
              <select class="provider-select w-full bg-claw-dark border border-claw-secondary/30 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-claw-primary" data-role-id="${role.id}">
                <option value="openai" ${role.provider === 'openai' ? 'selected' : ''}>OpenAI</option>
                <option value="anthropic" ${role.provider === 'anthropic' ? 'selected' : ''}>Anthropic (Claude)</option>
                <option value="ollama" ${role.provider === 'ollama' ? 'selected' : ''}>Ollama (本地模型)</option>
              </select>
            </div>
            <div>
              <label class="block text-sm text-claw-secondary mb-2">API 基础URL</label>
              <input type="text" class="api-base-url w-full bg-claw-dark border border-claw-secondary/30 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-claw-primary" data-role-id="${role.id}" value="${role.baseUrl}" placeholder="API地址（如：https://api.openai.com/v1）">
            </div>
            <div>
              <label class="block text-sm text-claw-secondary mb-2">API 密钥</label>
              <input type="password" class="api-key w-full bg-claw-dark border border-claw-secondary/30 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-claw-primary" data-role-id="${role.id}" value="${role.apiKey}" placeholder="OpenAI: sk-xxx | Claude: sk-ant-xxx | Ollama: 留空">
            </div>
            <div>
              <label class="block text-sm text-claw-secondary mb-2">角色设定（系统提示词）</label>
              <textarea class="system-prompt-input w-full bg-claw-dark border border-claw-secondary/30 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-claw-primary resize-none min-h-[120px]" data-role-id="${role.id}" placeholder="角色性格/回复要求">${role.systemPrompt}</textarea>
            </div>
            <div class="flex flex-col gap-2">
              <div class="flex items-center justify-between">
                <label class="block text-sm text-claw-secondary">可用模型</label>
                <button class="load-models-btn text-xs bg-claw-primary/80 hover:bg-claw-primary px-2 py-1 rounded transition-colors" data-role-id="${role.id}">
                  <i class="fa-solid fa-refresh mr-1"></i> 刷新模型
                </button>
              </div>
              <select class="model-select w-full bg-claw-dark border border-claw-secondary/30 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-claw-primary" data-role-id="${role.id}">
                ${PROVIDER_MODELS[role.provider].map(model => `
                  <option value="${model.id}" ${role.model === model.id ? 'selected' : ''}>${model.name}</option>
                `).join('')}
                <option value="" disabled>———— 自定义 ————</option>
                <option value="${role.model}" ${!PROVIDER_MODELS[role.provider].some(m => m.id === role.model) ? 'selected' : ''}>
                  ${role.modelName || role.model} (自定义)
                </option>
              </select>
            </div>
            <button class="save-role-btn w-full bg-claw-primary hover:bg-claw-primary/90 rounded-md px-3 py-2 text-sm font-medium transition-colors mt-2" data-role-id="${role.id}" onclick="saveRoleForm(${role.id})">
              保存角色配置
            </button>
          </div>
        `;
        roleListEl.appendChild(roleCard);
      });
      bindRoleCardEvents();
    }

    // 真正从 API 获取模型列表（修复核心）
    async function refreshModelList(roleId) {
      const role = roleList.find(r => r.id === roleId);
      if (!role) {
        alert('角色不存在');
        return;
      }

      // 检查必要配置
      if (!role.baseUrl || (role.provider !== 'ollama' && !role.apiKey)) {
        alert('请先填写 API 地址和密钥！');
        return;
      }

      // 禁用按钮并显示加载状态
      const btn = document.querySelector(`.load-models-btn[data-role-id="${roleId}"]`);
      const oldText = btn.innerHTML;
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> 获取中...';
      btn.disabled = true;

      try {
        let apiUrl = '';
        const headers = new Headers();
        headers.append('Content-Type', 'application/json');

        // 不同服务商的模型接口适配
        if (role.provider === 'openai') {
          // 处理 baseUrl 末尾的 /v1 后缀
          apiUrl = `${role.baseUrl.replace(/\/v1$/, '')}/v1/models`;
          headers.append('Authorization', `Bearer ${role.apiKey}`);
        } 
        else if (role.provider === 'anthropic') {
          // Claude 官方不开放模型列表接口，直接使用内置默认列表
          alert('Claude 暂不支持通过API获取模型列表，将使用内置默认模型');
          renderRoleList();
          return;
        } 
        else if (role.provider === 'ollama') {
          // Ollama 模型列表接口
          apiUrl = 'http://localhost:11434/api/tags';
        }

        // 发送请求获取模型列表
        const response = await fetch(apiUrl, {
          method: 'GET',
          headers: headers,
          signal: AbortSignal.timeout(10000) // 10秒超时
        });

        if (!response.ok) {
          throw new Error(`请求失败 [${response.status}]：${response.statusText}`);
        }

        const data = await response.json();
        let models = [];

        // 解析不同服务商的模型数据
        if (role.provider === 'openai') {
          // 过滤掉无效模型（embedding、音频等）
          models = data.data
            .map(item => ({ id: item.id, name: item.id }))
            .filter(m => !INVALID_MODEL_KEYWORDS.some(k => m.id.toLowerCase().includes(k)));
        } 
        else if (role.provider === 'ollama') {
          // Ollama 模型数据格式
          models = data.models.map(item => ({ id: item.name, name: item.name }));
        }

        // 检查是否获取到模型
        if (!models || models.length === 0) {
          alert('未获取到可用模型，将使用默认列表');
          renderRoleList();
          return;
        }

        // 更新全局模型列表并同步到角色配置
        PROVIDER_MODELS[role.provider] = models;
        // 将当前角色的模型设置为第一个可用模型
        role.model = models[0].id;
        role.modelName = models[0].name;

        // 保存配置并重新渲染
        saveRoleConfig();
        renderRoleList();
        alert(`成功获取 ${models.length} 个真实模型！`);

      } catch (error) {
        console.error('获取模型列表失败：', error);
        alert(`获取失败：${error.message}\n将使用本地默认模型`);
        renderRoleList();
      } finally {
        // 恢复按钮状态
        btn.innerHTML = oldText;
        btn.disabled = false;
      }
    }

    // 保存角色表单
    function saveRoleForm(roleId) {
      const role = roleList.find(r => r.id === roleId);
      if (!role) return;
      saveRoleConfig();
      alert(`角色「${role.name}」配置保存成功！`);
    }

    // 角色卡片事件绑定
    function bindRoleCardEvents() {
      // 折叠/展开
      document.querySelectorAll('.role-collapse-header').forEach(el => {
        el.addEventListener('click', () => {
          const contentEl = el.nextElementSibling;
          const iconEl = el.querySelector('.role-collapse-icon');
          contentEl.classList.toggle('hidden');
          iconEl.classList.toggle('role-collapse-active');
        });
      });
      // 启用/禁用
      document.querySelectorAll('.role-enable-switch').forEach(el => {
        el.addEventListener('change', () => {
          toggleRoleEnable(Number(el.dataset.roleId));
        });
      });
      // 删除角色
      document.querySelectorAll('.role-delete-btn').forEach(el => {
        el.addEventListener('click', () => {
          deleteRole(Number(el.dataset.roleId));
        });
      });
      // 选择头像
      document.querySelectorAll('.avatar-select-item').forEach(el => {
        el.addEventListener('click', () => {
          const roleId = Number(el.dataset.roleId);
          document.querySelectorAll(`.avatar-select-item[data-role-id="${roleId}"]`).forEach(item => item.classList.remove('active'));
          el.classList.add('active');
          updateRoleConfig(roleId, 'avatar', el.dataset.avatar);
          updateRoleConfig(roleId, 'avatarUrl', '');
          renderRoleList();
        });
      });
      // 自定义头像URL
      document.querySelectorAll('.avatar-url-input').forEach(el => {
        el.addEventListener('change', () => {
          const roleId = Number(el.dataset.roleId);
          updateRoleConfig(roleId, 'avatarUrl', el.value.trim());
          if (el.value.trim()) {
            document.querySelectorAll(`.avatar-select-item[data-role-id="${roleId}"]`).forEach(item => item.classList.remove('active'));
          }
          renderRoleList();
        });
      });
      // 角色信息修改
      document.querySelectorAll('.role-name-input, .provider-select, .api-base-url, .api-key, .system-prompt-input, .model-select').forEach(el => {
        el.addEventListener('change', () => {
          const roleId = Number(el.dataset.roleId);
          const field = el.className.includes('role-name') ? 'name' : 
                        el.className.includes('provider') ? 'provider' : 
                        el.className.includes('api-base') ? 'baseUrl' : 
                        el.className.includes('api-key') ? 'apiKey' : 
                        el.className.includes('model-select') ? 'model' : 'systemPrompt';
          updateRoleConfig(roleId, field, el.value.trim());
        });
      });
      // 绑定刷新模型按钮事件（新增核心绑定）
      document.querySelectorAll('.load-models-btn').forEach(el => {
        el.addEventListener('click', () => {
          const roleId = Number(el.dataset.roleId);
          refreshModelList(roleId);
        });
      });
    }

    // 本地存储
    function saveRoleConfig() {
      localStorage.setItem('openclaw-multi-role-config', JSON.stringify(roleList));
      localStorage.setItem('openclaw-role-id-counter', roleIdCounter.toString());
    }
    function loadRoleConfig() {
      const savedRoles = JSON.parse(localStorage.getItem('openclaw-multi-role-config')) || [];
      roleList = savedRoles.map(role => ({
        ...role,
        systemPrompt: role.systemPrompt || '你是一个友好的AI助手，回复简洁明了，逻辑清晰。',
        avatar: role.avatar || 'fa-cat',
        avatarUrl: role.avatarUrl || '',
        apiKey: role.apiKey || '',
        model: role.model || 'gpt-3.5-turbo',
        modelName: role.modelName || 'GPT-3.5 Turbo'
      }));
      roleIdCounter = Number(localStorage.getItem('openclaw-role-id-counter')) || 0;
    }
    function saveGlobalConfig() {
      localStorage.setItem('openclaw-multi-global-config', JSON.stringify({
        temperature: parseFloat(globalTemperature.value) || 0.7,
        maxTokens: parseInt(globalMaxTokens.value) || 1000,
        autoClearHistory: autoClearHistory.checked,
        autoAdjustTokens: autoAdjustTokens.checked,
        antiRepeatEnable: antiRepeatEnable.checked,
        proxyEnabled: globalProxyEnable.checked,
        noProxyDomains: globalNoProxyDomains.value.trim()
      }));
    }
    function loadGlobalConfig() {
      const savedConfig = JSON.parse(localStorage.getItem('openclaw-multi-global-config')) || {};
      globalTemperature.value = savedConfig.temperature ?? 0.7;
      globalMaxTokens.value = savedConfig.maxTokens ?? 1000;
      autoClearHistory.checked = savedConfig.autoClearHistory ?? false;
      autoAdjustTokens.checked = savedConfig.autoAdjustTokens ?? true;
      antiRepeatEnable.checked = savedConfig.antiRepeatEnable ?? true;
      globalProxyEnable.checked = savedConfig.proxyEnabled ?? false;
      globalNoProxyDomains.value = savedConfig.noProxyDomains ?? '';
    }
    function loadAllConfig() {
      loadRoleConfig();
      loadGlobalConfig();
      // 兼容旧配置
      if (roleList.length === 0 && localStorage.getItem('openclaw-model-config')) {
        const oldConfig = JSON.parse(localStorage.getItem('openclaw-model-config'));
        roleIdCounter = 1;
        roleList = [{
          id: 1, name: '猫猫AI助手1', avatar: 'fa-cat', avatarUrl: '', enable: false,
          provider: oldConfig.provider || 'openai', baseUrl: oldConfig.baseUrl || 'https://api.openai.com/v1',
          apiKey: '', model: 'gpt-3.5-turbo', modelName: 'GPT-3.5 Turbo',
          proxyEnabled: oldConfig.proxyEnabled || false, noProxyDomains: oldConfig.noProxyDomains || '',
          systemPrompt: '你是一个友好的AI助手，回复简洁明了，逻辑清晰。'
        }];
        saveRoleConfig();
      }
    }
    function clearChatHistory() {
      if (!confirm('确定清空所有对话历史？')) return;
      chatHistory = [];
      roundTableHistory = [];
      localStorage.removeItem('openclaw-multi-chat-history');
      renderChatHistory();
    }
    function resetAllConfig() {
      if (!confirm('确定重置所有配置？')) return;
      roleList = [];
      roleIdCounter = 0;
      chatHistory = [];
      roundTableHistory = [];
      localStorage.clear();
      loadAllConfig();
      renderRoleList();
      renderChatHistory();
      updateSendBtnStatus();
      updateRoundTableBtnStatus();
    }
    function exportAllConfig() {
      const blob = new Blob([JSON.stringify({
        version: '2.3',
        exportTime: new Date().toISOString(),
        roleList,
        globalConfig: JSON.parse(localStorage.getItem('openclaw-multi-global-config')) || {}
      }, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `猫猫AI配置-${new Date().toLocaleDateString().replace(/\//g, '-')}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // 聊天渲染
    function renderChatHistory() {
      chatContainer.innerHTML = '';
      const containerMaxWidth = 'max-w-4xl mx-auto w-full';
      if (chatHistory.length === 0 && roundTableHistory.length === 0) {
        chatContainer.innerHTML = `
          <div class="flex flex-col items-start gap-2 mb-8 ${containerMaxWidth}">
            <div class="flex items-center gap-2 mb-1">
              <i class="fa-solid fa-cat text-claw-primary"></i>
              <span class="font-medium">猫猫AI系统</span>
              <span class="text-xs text-claw-secondary">圆桌讨论版 v2.3 真实API版</span>
            </div>
            <div class="bg-claw-chat-ai rounded-lg rounded-tl-none px-4 py-3 w-full">
              配置流程：<b>新增角色 → 填写API信息 → 启用角色</b><br>
              圆桌讨论：输入主题+轮数，启动后AI角色多轮讨论反驳，最终生成结论！<br>
              <span class="text-claw-warning text-xs">真实模式：需填写有效API密钥，产生真实API调用费用</span>
            </div>
          </div>
        `;
        return;
      }
      
      // 渲染普通聊天
      chatHistory.forEach(msg => {
        if (msg.role === 'user') {
          renderUserMessage(msg.content, containerMaxWidth);
        } else {
          const role = roleList.find(r => r.id === msg.roleId);
          renderAIMessage(msg.content, msg.roleName, msg.roleId, false, containerMaxWidth, role?.avatar, role?.avatarUrl);
        }
      });

      // 渲染圆桌讨论
      roundTableHistory.forEach((round, idx) => {
        // 轮次标题
        const roundTitle = document.createElement('div');
        roundTitle.className = `round-table-header mb-4 ${containerMaxWidth}`;
        roundTitle.innerHTML = `<span class="font-medium">圆桌讨论 第 ${idx + 1} 轮</span><span class="round-table-round">(${round.topic})</span>`;
        chatContainer.appendChild(roundTitle);
        // 本轮消息
        round.messages.forEach(msg => {
          const role = roleList.find(r => r.id === msg.roleId);
          renderAIMessage(msg.content, msg.roleName, msg.roleId, false, containerMaxWidth, role?.avatar, role?.avatarUrl, true);
        });
      });

      // 最终总结
      if (roundTableHistory.length && roundTableHistory[0].finalSummary) {
        const summaryDiv = document.createElement('div');
        summaryDiv.className = `flex flex-col items-start gap-2 mb-6 ${containerMaxWidth}`;
        summaryDiv.innerHTML = `
          <div class="flex items-center gap-2 mb-1">
            <i class="fa-solid fa-flag-checkered text-claw-roundtable"></i>
            <span class="font-medium">圆桌讨论最终结论</span>
          </div>
          <div class="bg-claw-roundtable/20 border-l-4 border-claw-roundtable rounded-lg rounded-tl-none px-4 py-3 max-w-3xl w-full">
            ${roundTableHistory[0].finalSummary.replace(/\n/g, '<br>')}
          </div>
        `;
        chatContainer.appendChild(summaryDiv);
      }
    }

    function renderUserMessage(content, maxWidthClass) {
      const msgDiv = document.createElement('div');
      msgDiv.className = `flex flex-col items-end gap-2 mb-6 ${maxWidthClass}`;
      msgDiv.innerHTML = `
        <div class="flex items-center gap-2 mb-1">
          <span class="text-xs text-claw-secondary">你</span>
          <div class="w-6 h-6 rounded-full bg-claw-chat-user/50 flex items-center justify-center">
            <i class="fa-solid fa-user text-xs"></i>
          </div>
        </div>
        <div class="bg-claw-chat-user rounded-lg rounded-tr-none px-4 py-3 max-w-3xl">
          ${content.replace(/\n/g, '<br>')}
        </div>
      `;
      chatContainer.appendChild(msgDiv);
      scrollToBottom();
    }

    function renderAIMessage(content, roleName, roleId, isLoading = false, maxWidthClass, avatar = 'fa-cat', avatarUrl = '', isRoundTable = false) {
      const msgDiv = document.createElement('div');
      msgDiv.className = `flex flex-col items-start gap-2 mb-6 ${maxWidthClass} ${isRoundTable ? 'pl-4 border-l-2 border-claw-roundtable/30' : ''}`;
      msgDiv.innerHTML = `
        <div class="flex items-center gap-2 mb-1">
          <div class="w-6 h-6 rounded-full bg-claw-primary/20 flex items-center justify-center">
            ${avatarUrl ? 
              `<img src="${avatarUrl}" class="w-full h-full rounded-full object-cover" alt="${roleName}">` : 
              `<i class="fa-solid ${avatar} text-xs text-claw-primary"></i>`
            }
          </div>
          <span class="font-medium">${roleName}</span>
          <span class="text-xs text-claw-secondary">${isRoundTable ? '圆桌讨论' : 'AI'}</span>
        </div>
        <div class="bg-claw-chat-ai rounded-lg rounded-tl-none px-4 py-3 max-w-3xl w-full ai-content">
          ${isLoading ? '<i class="fa-solid fa-spinner fa-spin"></i> 思考中...' : content.replace(/\n/g, '<br>')}
        </div>
      `;
      chatContainer.appendChild(msgDiv);
      scrollToBottom();
      return msgDiv;
    }

    function scrollToBottom() {
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // 输入处理
    function handleInputKeydown(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleChatSubmit(e);
      }
    }

    // 按钮状态更新
    function updateSendBtnStatus() {
      const hasContent = chatInput.value.trim() !== '';
      const hasEnabledRole = roleList.some(role => role.enable);
      const isBusy = isGenerating || isRoundTableRunning;
      sendBtn.disabled = !hasContent || !hasEnabledRole || isBusy;
    }

    function updateRoundTableBtnStatus() {
      const hasTopic = roundTableTopic.value.trim() !== '';
      const hasRounds = parseInt(roundTableRounds.value) >= 1;
      const hasEnabledRole = roleList.some(role => role.enable);
      const isBusy = isGenerating || isRoundTableRunning;
      startRoundTableBtn.disabled = !hasTopic || !hasRounds || !hasEnabledRole || isBusy;
    }

    // 工具函数
    function shuffleArray(array) {
      const newArr = [...array];
      for (let i = newArr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
      }
      return newArr;
    }

    // 真实API调用核心函数（流式回复）
    async function callRealLLMApi(role, userInput, chatHistory, onChunk, onError) {
      const temperature = parseFloat(globalTemperature.value) || 0.7;
      const maxTokens = parseInt(globalMaxTokens.value) || 1000;
      const baseUrl = role.baseUrl.trim();
      const apiKey = role.apiKey.trim();
      const model = role.model.trim();
      const systemPrompt = role.systemPrompt.trim();

      // 构建请求头
      const headers = new Headers();
      headers.append('Content-Type', 'application/json');
      
      // 不同服务商的请求头
      if (role.provider === 'openai' && apiKey) {
        headers.append('Authorization', `Bearer ${apiKey}`);
      } else if (role.provider === 'anthropic' && apiKey) {
        headers.append('x-api-key', apiKey);
        headers.append('anthropic-version', '2023-06-01');
      }
      // Ollama 不需要API Key

      // 构建请求体
      let requestBody = {};
      let apiEndpoint = '';

      // 整理对话历史
      const messages = [
        { role: 'system', content: systemPrompt },
        ...chatHistory.map(msg => ({
          role: msg.role === 'user' ? 'user' : 'assistant',
          content: msg.content
        })),
        { role: 'user', content: userInput }
      ];

      try {
        // OpenAI 格式
        if (role.provider === 'openai') {
          apiEndpoint = `${baseUrl}/chat/completions`;
          requestBody = {
            model: model,
            messages: messages,
            temperature: temperature,
            max_tokens: maxTokens,
            stream: true,
            n: 1
          };
        } 
        // Anthropic (Claude) 格式
        else if (role.provider === 'anthropic') {
          apiEndpoint = `${baseUrl}/messages`;
          // Claude 需要把历史消息转成 content 数组
          const claudeMessages = messages.slice(1).map(msg => ({
            role: msg.role === 'assistant' ? 'assistant' : 'user',
            content: msg.content
          }));
          
          requestBody = {
            model: model,
            messages: claudeMessages,
            system: systemPrompt,
            temperature: temperature,
            max_tokens: maxTokens,
            stream: true
          };
        }
        // Ollama 格式（兼容OpenAI）
        else if (role.provider === 'ollama') {
          apiEndpoint = `${baseUrl}/chat/completions`;
          requestBody = {
            model: model,
            messages: messages,
            temperature: temperature,
            max_tokens: maxTokens,
            stream: true
          };
        }

        // 发送请求
        const response = await fetch(apiEndpoint, {
          method: 'POST',
          headers: headers,
          body: JSON.stringify(requestBody),
          signal: AbortSignal.timeout(90000) // 90秒超时
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`API请求失败 [${response.status}]：${errorText}`);
        }

        // 处理流式响应
        const reader = response.body.getReader();
        const decoder = new TextDecoder('utf-8');
        let buffer = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop() || '';

          for (const line of lines) {
            if (line.trim() === '' || line === 'data: [DONE]') continue;
            
            try {
              const data = line.startsWith('data: ') ? JSON.parse(line.slice(6)) : JSON.parse(line);
              
              // 处理不同服务商的流式数据
              let content = '';
              if (role.provider === 'openai' || role.provider === 'ollama') {
                content = data.choices?.[0]?.delta?.content || '';
              } else if (role.provider === 'anthropic') {
                content = data.delta?.text || '';
              }

              if (content) {
                onChunk(content);
              }
            } catch (e) {
              console.warn('解析流式数据失败:', e, line);
            }
          }
        }

      } catch (error) {
        console.error('API调用错误:', error);
        onError(error.message);
        throw error;
      }
    }

    // 普通聊天提交
    async function handleChatSubmit(e) {
      if (e) e.preventDefault();
      const userContent = chatInput.value.trim();
      const enabledRoles = roleList.filter(r => r.enable);
      
      if (!userContent || enabledRoles.length === 0) {
        alert('请输入内容并启用至少一个角色！');
        return;
      }

      // 更新状态
      isGenerating = true;
      statusText.classList.remove('hidden');
      sendBtn.disabled = true;
      chatInput.value = '';
      updateSendBtnStatus();
      updateRoundTableBtnStatus();

      // 渲染用户消息
      renderUserMessage(userContent);
      const userMsg = { role: 'user', content: userContent };
      chatHistory.push(userMsg);
      localStorage.setItem('openclaw-multi-chat-history', JSON.stringify(chatHistory));

      const shuffledRoles = shuffleArray(enabledRoles);
      const total = shuffledRoles.length;
      let idx = 0;

      try {
        for (const role of shuffledRoles) {
          idx++;
          currentRoleText.textContent = `(${idx}/${total}) ${role.name} 正在思考...`;
          const msgDiv = renderAIMessage('', role.name, role.id, true);
          const contentDiv = msgDiv.querySelector('.ai-content');
          let fullContent = '';

          // 调用真实API
          await callRealLLMApi(
            role, 
            userContent, 
            chatHistory.slice(0, -1), // 排除当前用户消息
            (chunk) => {
              fullContent += chunk;
              contentDiv.innerHTML = fullContent.replace(/\n/g, '<br>');
              scrollToBottom();
            },
            (errorMsg) => {
              contentDiv.innerHTML = `<span class="text-claw-danger">❌ 回复失败：${errorMsg}</span>`;
              throw new Error(errorMsg);
            }
          );

          if (fullContent.trim()) {
            const aiMsg = { role: 'assistant', roleId: role.id, roleName: role.name, content: fullContent };
            chatHistory.push(aiMsg);
            localStorage.setItem('openclaw-multi-chat-history', JSON.stringify(chatHistory));
          }
        }
        currentRoleText.textContent = '所有角色回复完成！';
        setTimeout(() => statusText.classList.add('hidden'), 2000);
      } catch (error) {
        console.error('聊天失败：', error);
        currentRoleText.textContent = `回复出错：${error.message}`;
        setTimeout(() => statusText.classList.add('hidden'), 5000);
      } finally {
        isGenerating = false;
        updateSendBtnStatus();
        updateRoundTableBtnStatus();
      }
    }

    // 圆桌讨论核心逻辑（真实API版）
    async function startRoundTableDiscussion() {
      const topic = roundTableTopic.value.trim();
      const totalRounds = parseInt(roundTableRounds.value);
      const enabledRoles = roleList.filter(r => r.enable);
      
      if (!topic || totalRounds < 1 || enabledRoles.length === 0) {
        alert('请输入讨论主题、选择轮数，并启用至少一个角色！');
        return;
      }

      // 初始化状态
      isRoundTableRunning = true;
      startRoundTableBtn.disabled = true;
      sendBtn.disabled = true;
      statusText.classList.remove('hidden');
      roundTableHistory = [];
      currentRoleText.textContent = `圆桌讨论开始，共${totalRounds}轮...`;

      try {
        // 多轮讨论
        let allDiscussionHistory = []; // 存储所有轮次的讨论历史
        for (let round = 1; round <= totalRounds; round++) {
          currentRoleText.textContent = `圆桌讨论 第${round}/${totalRounds}轮 进行中...`;
          const roundData = { topic, messages: [] };
          roundTableHistory.push(roundData);
          
          // 本轮讨论：每个角色基于历史发言
          const shuffledRoles = shuffleArray(enabledRoles);
          for (let i = 0; i < shuffledRoles.length; i++) {
            const role = shuffledRoles[i];
            // 构建本轮发言的上下文
            const roundContext = [
              `当前是圆桌讨论第${round}轮，讨论主题：${topic}`,
              `历史讨论内容：${allDiscussionHistory.map(m => `${m.roleName}：${m.content}`).join('；')}`,
              `请你以${role.name}的身份，针对上述讨论发表你的观点或反驳意见`
            ].join('\n');
            
            currentRoleText.textContent = `第${round}轮 - ${role.name} 正在发言...`;
            // 渲染加载中的消息
            const msgDiv = renderAIMessage('', role.name, role.id, true, 'max-w-4xl mx-auto w-full', role.avatar, role.avatarUrl, true);
            const contentDiv = msgDiv.querySelector('.ai-content');
            let fullContent = '';

            // 调用真实API
            await callRealLLMApi(
              role, 
              roundContext, 
              [], 
              (chunk) => {
                fullContent += chunk;
                contentDiv.innerHTML = fullContent.replace(/\n/g, '<br>');
                scrollToBottom();
              },
              (errorMsg) => {
                contentDiv.innerHTML = `<span class="text-claw-danger">❌ 发言失败：${errorMsg}</span>`;
                throw new Error(errorMsg);
              }
            );

            // 保存本轮发言
            if (fullContent.trim()) {
              const msg = {
                roleId: role.id,
                roleName: role.name,
                content: fullContent
              };
              roundData.messages.push(msg);
              allDiscussionHistory.push(msg);
            }
          }
          renderChatHistory();
          await new Promise(resolve => setTimeout(resolve, 1000)); // 轮间间隔
        }

        // 生成最终总结
        currentRoleText.textContent = '生成圆桌讨论最终结论...';
        const summaryRole = enabledRoles[0];
        const summaryContext = [
          `请总结以下圆桌讨论的内容，主题：${topic}，共${totalRounds}轮`,
          '讨论内容：',
          ...allDiscussionHistory.map((msg, idx) => `第${Math.floor(idx/enabledRoles.length)+1}轮 - ${msg.roleName}：${msg.content}`),
          '要求：1. 总结核心观点和分歧 2. 给出最终共识 3. 语言简洁条理清晰'
        ].join('\n');

        const summaryDiv = renderAIMessage('', '系统总结', 0, true, 'max-w-4xl mx-auto w-full', 'fa-flag-checkered', '', true);
        const summaryContentDiv = summaryDiv.querySelector('.ai-content');
        let finalSummary = '';

        // 调用API生成总结
        await callRealLLMApi(
          summaryRole, 
          summaryContext, 
          [], 
          (chunk) => {
            finalSummary += chunk;
            summaryContentDiv.innerHTML = finalSummary.replace(/\n/g, '<br>');
            scrollToBottom();
          },
          (errorMsg) => {
            summaryContentDiv.innerHTML = `<span class="text-claw-danger">❌ 总结失败：${errorMsg}</span>`;
            throw new Error(errorMsg);
          }
        );

        roundTableHistory[0].finalSummary = finalSummary;
        renderChatHistory();
        currentRoleText.textContent = '圆桌讨论完成！';
      } catch (error) {
        console.error('圆桌讨论失败：', error);
        currentRoleText.textContent = `讨论出错：${error.message}`;
        setTimeout(() => statusText.classList.add('hidden'), 5000);
      } finally {
        isRoundTableRunning = false;
        updateSendBtnStatus();
        updateRoundTableBtnStatus();
      }
    }
  </script>
</body>
</html>